<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <style type="text/css">
  </style>
</head>
<body>
<script type="text/jdists"> /*<debug>*/
  var h1 = document.querySelector('h1');
  h1.innerHTML += ' 2014';
  /*</debug>*/
  /*<replace>console.log('可以写在一行');</replace>*/</script>
<script>
(function() {
  /**
   * 编译块
   * @param {string} content 内容
   * @param {Function} onread 读取函数
   * @param {boolean} isReplace 是否替换过程
   * @return 返回编译后的内容
   */
  var buildBlock = function(content, onread, isReplace) {
    var content = String(content);
    // @group
    // fl, tag, attrs, fr, content, end
    var regexList = [
      // xml
      /^(<!--)([\w-_.]+)((?:\s*[\w-_.]+\s*=\s*"[^"]+")+)?()()(\s*\/-->)/,
      /^(<!--)([\w-_.]+)((?:\s*[\w-_.]+\s*=\s*"[^"]+")+)?(\s*-->)([^]*?)(<!--\/\2-->)/,
      /^(<!--)([\w-_.]+)((?:\s*[\w-_.]+\s*=\s*"[^"]+")+)?(\s*>)([^]*?)(<\/\2-->)/,

      // c \ c++ \ c# \ java \ js \ css
      /^(\/\*<)([\w-_.]+)((?:\s*[\w-_.]+\s*=\s*"[^"]+")+)?()()(\s*\/>\*\/)/,
      /^(\/\*<)([\w-_.]+)((?:\s*[\w-_.]+\s*=\s*"[^"]+")+)?(\s*>\*\/)([^]*?)(\/\*<\/\2>\*\/)/,
      /^(\/\*<)([\w-_.]+)((?:\s*[\w-_.]+\s*=\s*"[^"]+")+)?(\s*>)([^]*?)(<\/\2>\*\/)/,

      // pascal \ delphi
      /^(\(\*<)([\w-_.]+)((?:\s*[\w-_.]+\s*=\s*"[^"]+")+)?()()(\s*\/>\*\))/,
      /^(\(\*<)([\w-_.]+)((?:\s*[\w-_.]+\s*=\s*"[^"]+")+)?(\s*>\*\))([^]*?)(\(\*<\/\2>\*\))/,
      /^(\(\*<)([\w-_.]+)((?:\s*[\w-_.]+\s*=\s*"[^"]+")+)?(\s*>)([^]*?)(<\/\2>\*\))/,

      // python
      /^('''<)([\w-_.]+)((?:\s*[\w-_.]+\s*=\s*"[^"]+")+)?()()(\s*\/>''')/,
      /^('''<)([\w-_.]+)((?:\s*[\w-_.]+\s*=\s*"[^"]+")+)?(\s*>''')([^]*?)('''<\/\2>''')/,
      /^('''<)([\w-_.]+)((?:\s*[\w-_.]+\s*=\s*"[^"]+")+)?(\s*>)([^]*?)(<\/\2>''')/
    ];

    var flags = ['<!--', '/*<', '(*<', "'''"];

    var result = '';
    var start = 0;
    while (start < content.length) {
      var min = Infinity;
      var regexIndex;

      flags.forEach(function(flag, index) {
        var t = content.substring(start).indexOf(flag);
        if (t >= 0 && t < min) {
          min = t;
          regexIndex = index * 3;
        }
      });

      if (min >= Infinity) { // 没有找到语法
        break;
      }

      var pointer = start + min;
      var match = false;

      for (var j = regexIndex; j <= regexIndex + 3; j++) {
        match = content.substring(pointer).match(regexList[j]);
        console.log(pointer, match);
        if (match) {
          match = match.map(function(item) { // 避免 undefined
            return item || '';
          });
          match.push(pointer);
          result += content.substring(start, pointer);
          result += onread.apply(this, match);

          start = pointer + match[0].length;
          break;
        }
      }

      if (!match) {
        result += content.substring(start, start + 1);
        start++;
      }
    }
    result += content.substring(start);

    if (isReplace) {
      result = String(result).replace( // 处理注释模板
        /\/\*#\*\/\s*function\s*\(\s*\)\s*\{\s*\/\*\!?([^]*?)\*\/[\s;]*\}/g,
        function(all, text) {
          return JSON.stringify(text);
        }
      ).replace(/\/\*,\*\/\s*(function(?:\s+[\w$_]+)?\s*\(\s*([^()]+)\s*\))/g, // 处理参数自识别
        function(all, func, params) {
          return '[' + params.replace(/([^\s,]+)/g, "'$&'") + '], ' + func;
        }
      );
    }

    return result;
  };

  var output = buildBlock(document.querySelector('script[type="text/jdists"]').innerHTML,
    function(all, fl, tag, attrText, fr, content, end, pos) {
      console.log('【' + content + '】');
      return '!!!!';
    }
  );

  console.log('output: ', output);
})();
</script>
</body>
</html>